{% extends "admin/change_list.html" %}
{% load i18n unfold %}
{% load accounting_filters %}

{% block content_title %}
    <h1>Dashboard - FinanzÃ¼bersicht</h1>
{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    .chart-container {
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        border: 1px solid #374151;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        margin-bottom: 2rem;
    }

    .controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: center;
    }

    .controls select,
    .controls button {
        padding: 0.5rem 1rem;
        border: 1px solid #374151;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        background: white;
        color: #1f2937;
    }

    .controls button {
        background: #3b82f6;
        color: white;
        border: none;
        cursor: pointer;
    }

    .controls button:hover {
        background: #2563eb;
    }
</style>
{% endblock %}

{% block content %}
    <div style="margin-bottom: 2rem; width: 100%; order: -1;">
        <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; width: 100%;">

            {# Card 1: Einnahmen #}
            <div style="flex: 1; min-width: 250px; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                <h3 style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                    ðŸ’° Gesamt Einnahmen
                </h3>
                <p style="font-size: 1.875rem; font-weight: bold; color: #10b981; margin-bottom: 0.5rem;">
                    {{ total_income|format_thousands }}â‚¬
                </p>
                <p style="font-size: 0.75rem;">
                    Alle bezahlten Rechnungen
                </p>
            </div>

            {# Card 2: Ausgaben #}
            <div style="flex: 1; min-width: 250px; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                <h3 style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                    ðŸ’¸ Gesamt Ausgaben
                </h3>
                <p style="font-size: 1.875rem; font-weight: bold; color: #ef4444; margin-bottom: 0.5rem;">
                    {{ total_expense|format_thousands }}â‚¬
                </p>
                <p style="font-size: 0.75rem;">
                    Stornierungen & Gegenbuchungen
                </p>
            </div>

            {# Card 3: Gewinn #}
            <div style="flex: 1; min-width: 250px; border: 1px solid #374151; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.3);">
                <h3 style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">
                    ðŸ“Š Netto Gewinn
                </h3>
                <p style="font-size: 1.875rem; font-weight: bold; color: {% if net_profit >= 0 %}#3b82f6{% else %}#ef4444{% endif %}; margin-bottom: 0.5rem;">
                    {{ net_profit|format_thousands }}â‚¬
                </p>
                <p style="font-size: 0.75rem;">
                    Einnahmen minus Ausgaben
                </p>
            </div>

        </div>
    </div>

    {# Chart Section #}
    <div class="chart-container">
        <div class="controls">
            <label for="viewType">Ansicht:</label>
            <select id="viewType">
                <option value="year">Nach Jahren</option>
                <option value="month">Nach Monaten</option>
            </select>

            <label for="yearSelect" id="yearLabel" style="display: none;">Jahr:</label>
            <select id="yearSelect" style="display: none;">
                {# Jahre werden dynamisch geladen #}
            </select>

            <button onclick="updateChart()">Aktualisieren</button>
        </div>

        <canvas id="accountingChart"></canvas>
    </div>

    {# HIDE original changelist table #}
    <style>
        #changelist {
            display: none;
        }
    </style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Markiere Dashboard Tab als aktiv
    document.addEventListener('DOMContentLoaded', function() {
        const tabs = document.querySelectorAll('a[href*="accounting_accountingentry"]');
        tabs.forEach(tab => {
            const href = tab.getAttribute('href');
            const isTabDashboard = href && href.includes('view=dashboard');

            // Entferne aktive Klassen von allen Tabs
            tab.classList.remove('border-primary-600', 'dark:border-primary-500', 'text-primary-600', 'dark:text-primary-400');

            // FÃ¼ge aktive Klasse nur zum Dashboard Tab hinzu
            if (isTabDashboard) {
                tab.classList.add('border-primary-600', 'dark:border-primary-500', 'text-primary-600', 'dark:text-primary-400');
            }
        });
    });

    let chart = null;
    const currentYear = new Date().getFullYear();

    // Toggle Jahr-Auswahl basierend auf View-Type
    document.getElementById('viewType').addEventListener('change', function() {
        const yearSelect = document.getElementById('yearSelect');
        const yearLabel = document.getElementById('yearLabel');
        if (this.value === 'month') {
            yearSelect.style.display = 'block';
            yearLabel.style.display = 'block';
            loadAvailableYears();
        } else {
            yearSelect.style.display = 'none';
            yearLabel.style.display = 'none';
        }
    });

    function loadAvailableYears() {
        // Lade verfÃ¼gbare Jahre Ã¼ber API
        fetch('/admin/accounting/api/chart-data/?view=year')
            .then(response => response.json())
            .then(data => {
                const yearSelect = document.getElementById('yearSelect');
                yearSelect.innerHTML = '';

                // FÃ¼ge Jahre aus Daten hinzu + aktuelles Jahr
                const years = new Set(data.labels.map(y => parseInt(y)));
                years.add(currentYear);

                Array.from(years).sort((a, b) => b - a).forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                });
            });
    }

    function updateChart() {
        const viewType = document.getElementById('viewType').value;
        const year = document.getElementById('yearSelect').value;

        let url = '/admin/accounting/api/chart-data/?view=' + viewType;
        if (viewType === 'month') {
            url += '&year=' + year;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (chart) {
                    chart.destroy();
                }

                const ctx = document.getElementById('accountingChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Einnahmen',
                                data: data.income,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: 'Ausgaben',
                                data: data.expense,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(0) + 'â‚¬';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + 'â‚¬';
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
            });
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        updateChart();
    });
</script>
{% endblock %}
